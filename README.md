# Kubernetes Auto Ingress Operator

This project implements a Kubernetes operator using the [Kopf](https://kopf.readthedocs.io/en/stable/) framework. The operator automatically creates and manages Kubernetes Ingress resources for Services based on a specific annotation.

## Task Description

One way to expose a Kubernetes web service to the outside world is to create a corresponding ingress rule in the Ingress Gateway.

The task was to automate this process. This operator maintains an ingress rule for every service that has an `auto-ingress` annotation. For the example below, it creates an ingress rule named `auto-ingress-<service-name>-http` for the service named `my-service`. The target path in the rule is defined by the value of the service annotation.

Moreover, the operator ensures the Ingress rule is kept up-to-date if the annotation changes or is removed, or if the service itself is deleted (leveraging Kubernetes garbage collection via OwnerReferences).

(We call this automation an operator, but depending on the naming conventions, sometimes the word "controller" is used instead for this simple task.)

## Implementation Details

The operator is written in Python using the Kopf framework and the official Kubernetes Python client.

-   It watches for `create`, `update`, and `resume` events on `v1/Service` resources cluster-wide.
-   When a Service event occurs, it checks for the `auto-ingress` annotation in the Service's metadata.
-   **Annotation Present:**
    -   If the annotation exists, it constructs an Ingress resource definition.
    -   The Ingress name follows the pattern `auto-ingress-<service-name>-http`.
    -   The Ingress path is taken from the annotation value (e.g., `/aaa`).
    -   The Ingress backend targets the Service name and the *first port* defined in the Service spec. It prioritizes using the port `name` if available, otherwise uses the port `number`.
    -   A Traefik-specific annotation (`traefik.ingress.kubernetes.io/router.entrypoints: web`) is added to the Ingress metadata.
    -   An `OwnerReference` is set on the Ingress, pointing to the Service. This ensures the Ingress is automatically deleted when the Service is deleted.
    -   The operator attempts to create the Ingress. If it already exists, it updates (replaces) it.
-   **Annotation Absent:**
    -   If the annotation does not exist, the operator checks if it existed previously (on an update event).
    -   If the annotation was removed, the operator explicitly deletes the corresponding Ingress resource.
    -   If the annotation was never present, no action is taken regarding Ingress creation or deletion.
-   **Service Deletion:**
    -   The operator logs the deletion of a Service. The actual deletion of the corresponding Ingress (if one was created by the operator) is handled by the Kubernetes garbage collector due to the `OwnerReference`.

## Usage

1.  **Deploy the Operator:**
    *   Build a container image for the operator (Dockerfile not provided in this example).
    *   Deploy the operator to your Kubernetes cluster. This typically involves creating a Deployment, ServiceAccount, ClusterRole, and ClusterRoleBinding to grant the necessary permissions (watch Services, create/update/delete Ingresses).
    *   Run the operator using `kopf run /path/to/auto-ingress-operator.py --all-namespaces` (or adapt for specific namespaces).

2.  **Annotate Your Services:**
    *   Add the `auto-ingress: "<your-desired-path>"` annotation to the `metadata` section of any Service you want to expose via an automatically generated Ingress rule.

## Example Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
  annotations:
    auto-ingress: "/aaa" # This annotation triggers the operator
spec:
  selector:
    app: my-server
  ports:
    - name: http # The operator will use this port name
      protocol: TCP
      port: 80
      targetPort: 8080
```

## Example Ingress (Generated by the Operator)

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auto-ingress-my-service-http # Generated name
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web # Added by the operator
  ownerReferences: # Added by the operator
    - apiVersion: v1
      kind: Service
      name: my-service
      uid: <service-uid> # Actual UID will be populated
      controller: true
      blockOwnerDeletion: true
spec:
  rules:
    - http:
        paths:
          - path: "/aaa" # From the annotation
            pathType: Prefix
            backend:
              service:
                name: my-service # Service name
                port:
                  name: http # Service port name (preferred)
#                 If the service port had no name, it would use:
#                 port:
#                   number: 80 # Service port number
```

## Resources and Background Literature

-   [Kubernetes Documentation: Ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/)
-   [Kopf: Kubernetes Operators Framework](https://kopf.readthedocs.io/en/stable/)
-   [Kubernetes Python Client](https://github.com/kubernetes-client/python)